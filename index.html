<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="icon" href="assets/img/favicon.svg" type="image/x-icon" />
    <script src="js/script.js"></script>
    <script type="module" src="js/vue.js"></script>
    <title>Dashboard - Projektorganisation</title>
</head>

<body id="app">
    <nav class="side-bar">
        <section class="navigation">
            <section class="side-bar-title">
                <h1>Projektzeit</h1>
            </section>
            <ul class="side-bar-list">
                <li class="side-bar-list-item"><a href="#dashboard" class="active">Dashboard</a></li>
                <li class="side-bar-list-item"><a href="#recording">Zeiterfassung</a></li>
                <li class="side-bar-list-item"><a href="#projects">Projekte</a></li>
                <li class="side-bar-list-item"><a href="#allocation">Zuweisungen</a></li>
                <li class="side-bar-list-item" id="approval-nav"><a href="#approval">Bewilligung</a></li>
            </ul>
        </section>

        <section class="user-login">
            <select class="year-select" id="year" v-model="selectedYear" @change="selectedName = ''">
                <option disabled value="">Lehrgang</option>
                <option v-for="y in yearOptions" :key="y" :value="y">Lehrgang {{ y }}</option>
            </select>

            <select class="name-select" id="name" v-model="selectedName" :disabled="!selectedYear">
                <option disabled value="">Name</option>
                <option v-for="s in nameOptions" :key="s.ID" :value="s.Fullname">{{ s.Fullname }}</option>
            </select>

            <button class="user-login-button" id="user-login-button" @click="handleLogin">LogIn</button>

            <div class="checkbox-wrapper">
                <p class="admin-toggle-label">Admin</p>
                <div>
                    <input class="tgl tgl-ios" id="admin-toggle" type="checkbox" v-model="isAdmin" />
                    <label class="tgl-btn" for="admin-toggle" data-tg-off="Student" data-tg-on="Admin"></label>
                </div>
            </div>
            <div v-if="isLoggedIn" class="login-info">
                <p style="margin: 0, 0, 0, .5em; font-size:0.9rem; color:var(--text-muted)">
                    Eingeloggt als <strong>{{ loggedInStudent.Fullname }}</strong><br>
                    Lehrgang: {{ loggedInStudent.Year }}
                </p>
                <button class="user-login-button logout-btn" @click="logout"
                    style="margin-top:0.5rem; background:#ef4444;">
                    Logout
                </button>
            </div>
        </section>


    </nav>
    <main>

        <section class="dashboard" id="dashboard">
            <section class="site-header">
                <h2>Dashboard</h2>
                <p class="subtitle">Übersicht Ihrer Zeiterfassung und Projekte</p>
                <p v-if="isLoggedIn" style="margin-top:.5rem; color:var(--text-muted)">
                    Eingeloggt als <strong>{{ loggedInStudent.Fullname }}</strong> (Lehrgang {{ loggedInStudent.Year }})
                </p>
            </section>


            <section class="dashboard-overview">
                <div class="dashboard-overview-card">
                    <h3>Zu bewilligen</h3>
                    <div class="dashboard-overview-value waiting">{{ dashboardStats.pendingCount }}</div>
                    <p>Wartende Einträge</p>
                </div>

                <div class="dashboard-overview-card">
                    <h3>Bewilligt</h3>
                    <div class="dashboard-overview-value confirmed">{{ dashboardStats.approvedHrs }}</div>
                    <p>Genehmigte Stunden</p>
                </div>

                <div class="dashboard-overview-card">
                    <h3>Abgelehnt</h3>
                    <div class="dashboard-overview-value rejected">{{ dashboardStats.rejectedCount }}</div>
                    <p>Zurückgewiesene Einträge</p>
                </div>

                <div class="dashboard-overview-card">
                    <h3>Gesamtstunden</h3>
                    <div class="dashboard-overview-value total">{{ dashboardStats.totalHrs }}</div>
                    <p>Erfasste Stunden</p>
                </div>
            </section>

            <section class="dashboard-overview" style="margin-top:1rem;">
                <div class="card section">
                    <h3 style="margin:0 0 .5rem 0;">Dieser Monat</h3>
                    <p style="font-size:2rem; margin:0; font-weight:700;">{{ monthHours }} h</p>
                    <p class="subtitle" style="margin:.25rem 0 0 0; color:var(--text-muted);">Summe aller erfassten
                        Stunden</p>
                </div>

                <div class="card section">
                    <h3 style="margin:0 0 .5rem 0;">Top-Projekte</h3>
                    <table v-if="topProjects.length">
                        <thead>
                            <tr>
                                <th style="text-align:left;">Projekt</th>
                                <th style="text-align:right;">Stunden</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="p in topProjects" :key="p.name">
                                <td>{{ p.name }}</td>
                                <td style="text-align:right;">{{ p.hours }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p v-else style="color:var(--text-muted)">Keine Daten</p>
                </div>
            </section>


        </section>

        <section class="recording" id="recording">
            <section class="site-header">
                <h2>Zeiterfassung</h2>
                <button class="site-header-button" @click="showPopupRecord = true">+ Neue Zeiterfassung</button>
            </section>
            <section class="section">
                <p v-if="error" style="color:red">{{ error }}</p>

                <table v-if="timesheetViewFiltered.length > 0">
                    <thead>
                        <tr>
                            <th>Projekt</th>
                            <th>Datum</th>
                            <th>Stunden</th>
                            <th>Student</th>
                            <th>Status</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in timesheetViewFiltered" :key="item.ID">
                            <td>{{ item.ProjectName }}</td>
                            <td>{{ formatDate(item.Date) }}</td>
                            <td>{{ formatHours(item.Minutes) }}</td>
                            <td>{{ item.Fullname }}</td>
                            <td>
                                <span :class="[
                                    'badge',
                                    item.Approved === 1 ? 'badge--green' :
                                    item.Approved === 0 ? 'badge--red'   :
                                    item.Approved === 2 ? 'badge--yellow': 'badge--blue'
                                     ]">
                                    {{ approvedText(item.Approved) }}
                                </span>
                            </td>



                            <td class="actions">
                                <button class="edit-btn" @click="editEntry(item)">✍️</button>
                                <button class="delete-btn" @click="deleteEntry(item.ID)">❌</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Popup: Timesheet -->
            <div v-if="showPopupRecord" class="popup-overlay">
                <div class="popup">
                    <h3>{{ isEditing ? 'Zeiterfassung bearbeiten' : 'Neue Zeiterfassung' }}</h3>
                    <label>Projekt</label>
                    <select v-model="newEntry.ProjectName">
                        <option disabled value="">Projekt auswählen</option>
                        <option v-for="p in projects" :key="p.ID">{{ p.Name }}</option>
                    </select>
                    <label>Student</label>
                    <select v-model="newEntry.studentName">
                        <option disabled value="">Student auswählen</option>
                        <option v-for="s in students" :key="s.ID">{{ s.Fullname }}</option>
                    </select>
                    <label>Datum</label>
                    <input type="date" v-model="newEntry.date" />
                    <label>Stunden</label>
                    <input type="number" min="0" step="0.25" v-model="newEntry.hours" />
                    <div class="popup-actions">
                        <button @click="showPopupRecord = false" style="background:#64748b">Abbrechen</button>
                        <button @click="saveTimesheet">Speichern</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="projects" id="projects">
            <section class="site-header">
                <h2>Projekte</h2>
                <button class="site-header-button" @click="openProjectCreate">+ Neues Projekt</button>
            </section>

            <section class="section">
                <p v-if="projectError" style="color:red">{{ projectError }}</p>

                <table v-if="projectsFiltered.length > 0">
                    <thead>
                        <tr>
                            <th>Nr.</th>
                            <th>Name</th>
                            <th>Coach</th>
                            <th>Typ</th>
                            <th>Kunde</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in projectsFiltered" :key="p.ID">
                            <td>{{ p.Number || '—' }}</td>
                            <td>{{ p.Name }}</td>
                            <td>{{ p.Coach || '—' }}</td>
                            <td>{{ typeName(p.TypeID) }}</td>
                            <td>{{ customerName(p.CustomerID) }}</td>
                            <td class="actions">
                                <button class="edit-btn" @click="editProject(p)">✍️</button>
                                <button class="delete-btn" @click="deleteProject(p.ID)">❌</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <p v-else style="color: var(--text-muted)">Keine Projekte gefunden.</p>
            </section>

            <!-- Popup: Projekt anlegen/bearbeiten -->
            <div v-if="showProjectPopup" class="popup-overlay">
                <div class="popup">
                    <h3>{{ isEditingProject ? 'Projekt bearbeiten' : 'Neues Projekt' }}</h3>

                    <label>Nummer</label>
                    <input type="text" v-model="projectForm.Number" placeholder="z. B. P-2025-001" />

                    <label>Name</label>
                    <input type="text" v-model="projectForm.Name" placeholder="Projektname" />

                    <label>Beschreibung</label>
                    <input type="text" v-model="projectForm.Description" placeholder="Kurzbeschreibung" />

                    <label>Coach</label>
                    <input type="text" v-model="projectForm.Coach" placeholder="Coach-Name" />
                    <label>Typ</label>
                    <select v-model.number="projectForm.TypeID">
                        <option :value="0" disabled>Typ auswählen</option>
                        <option v-for="t in projectTypes" :key="t.ID" :value="t.ID">{{ t.Name }}</option>
                    </select>
                    <label>Kunde</label>
                    <select v-model.number="projectForm.CustomerID">
                        <option :value="0" disabled>Kunde auswählen</option>
                        <option v-for="c in customers" :key="c.ID" :value="c.ID">{{ c.Name }}</option>
                    </select>

                    <div class="popup-actions">
                        <button @click="closeProjectPopup" style="background:#64748b">Abbrechen</button>
                        <button @click="saveProject">Speichern</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="allocation" id="allocation">
            <section class="allocation" id="allocation">
                <section class="site-header">
                    <h2>Zuweisungen</h2>
                    <p class="subtitle">Übersicht: In welche Projekte eine Person (Schüler oder Coach) involviert ist
                    </p>
                </section>

                <section class="section">
                    <!-- Filterleiste -->
                    <div class="filter-bar"
                        style="display:flex; flex-wrap:wrap; gap:1rem; align-items:center; margin-bottom:1rem;">
                        <div style="display:flex; gap:.5rem; align-items:center;">
                            <label style="font-weight:600;">Rolle:</label>
                            <select v-model="roleFilter" class="name-select">
                                <option value="student">Schüler</option>
                                <option value="coach">Coach</option>
                            </select>
                        </div>

                        <div style="display:flex; gap:.5rem; align-items:center;">
                            <label style="font-weight:600;">Person:</label>
                            <select v-model="selectedPerson" class="name-select">
                                <option disabled value="">Bitte wählen</option>
                                <option v-for="n in personOptions" :key="n" :value="n">{{ n }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabelle -->
                    <table v-if="selectedPerson && involvementRows.length">
                        <thead>
                            <tr>
                                <th>Nr.</th>
                                <th>Projekt</th>
                                <th>Coach</th>
                                <th>Typ</th>
                                <th>Kunde</th>
                                <th>Stunden</th>
                                <th>Einträge</th>
                                <th>Letzte Aktivität</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in involvementRows" :key="row.ProjectName">
                                <td>{{ row.Number }}</td>
                                <td>{{ row.ProjectName }}</td>
                                <td>{{ row.Coach }}</td>
                                <td>{{ row.TypeName }}</td>
                                <td>{{ row.CustomerName }}</td>
                                <td>{{ formatHours(row.Minutes) }}</td>
                                <td>{{ row.Entries }}</td>
                                <td>{{ row.LastDate ? row.LastDate.toLocaleDateString('de-CH') : '—' }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <p v-else-if="selectedPerson && !involvementRows.length" style="color:var(--text-muted)">
                        Keine Projekte gefunden.
                    </p>
                    <p v-else style="color:var(--text-muted)">
                        Bitte Rolle und Person auswählen.
                    </p>
                </section>
            </section>

        </section>

        <section class="approval" id="approval">
            <section class="approval" id="approval">
                <section class="site-header">
                    <h2>Bewilligung</h2>
                    <p class="subtitle">Übersicht von Anträge die zu Bewilligen sind</p>
                </section>

                <section class="section">
                    <!-- Filter -->
                    <div class="filter-bar" style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
                        <label for="approval-filter" style="font-weight:600;">Status:</label>
                        <select id="approval-filter" v-model="approvalFilter" class="name-select">
                            <option value="all">Alle</option>
                            <option value="pending">Ausstehend</option>
                            <option value="approved">Angenommen</option>
                            <option value="rejected">Abgelehnt</option>
                        </select>
                    </div>

                    <!-- Tabelle -->
                    <table v-if="approvalsFiltered.length > 0">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Projekt</th>
                                <th>Datum</th>
                                <th>Stunden</th>
                                <th>Status</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in approvalsFiltered" :key="item.ID">
                                <td>{{ item.Fullname }}</td>
                                <td>{{ item.ProjectName }}</td>
                                <td>{{ formatDate(item.Date) }}</td>
                                <td>{{ formatHours(item.Minutes) }}</td>
                                <td :class="{
                'status-red': Number(item.Approved) === 0,
                'status-green': Number(item.Approved) === 1,
                'status-yellow': Number(item.Approved) === 2
              }">
                                    {{ approvedText(item.Approved) }}
                                </td>
                                <td class="actions" style="display:flex; gap:.5rem;">
                                    <button class="site-header-button" @click="setApproval(item, 1)">✅
                                        Annehmen</button>
                                    <button class="delete-btn" @click="setApproval(item, 0)">🚫 Ablehnen</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <p v-else style="color: var(--text-muted)">Keine Einträge für diesen Filter.</p>
                </section>
            </section>

        </section>
    </main>

</body>

</html>